<div class="formCol">
	<div id="gridLBox">
		<a id="maplinkL" href="gmap.html" target="_blank">See a fullscreen map</a>
		<iframe id="gridL" src="gmap.html"></iframe>
	</div>
	<div id="theForum" class="form-horizontal"></div>
</div>
<div class="gridCol">
	<div id="gridRBox">
		<a id="maplinkR" href="gmap.html" target="_blank">See a fullscreen map</a>
		<iframe id="gridR" src="gmap.html"></iframe>
	</div>
	<iframe id= "desc" src="parameter_descriptions.html" frameBorder="0">
	Your browser doesn't support iframes.
	</iframe>
</div>
<script type="text/javascript">
	loadForm();
	function loadForm() {
		var form = "";
		var timestamp = -1;
		$.get("Form.xml", function(data) {
			var xml = $($.parseXML(data));
			xml.find('Group').each(function() {
				//Traverse the xml tree
				var groupID = "";
				var id = $(this).attr("id");
				form += "<h3>" + id + "</h3>";
				//Access field tags
				$(this).find('Fields').find('Field').each(function() {
					id = $(this).attr("id");
					var label = $(this).attr("label");
					var type = $(this).attr("type");
					var toolTip = $(this).attr("toolTip");
					var value = $(this).text().replace(/\s/g, "");

					if (type == 'text') {
						form += "<div id=\"" + id + "-cg\" class=\"control-group\">" 
							+ "<a class=\"link\" data-original-title=\"" + toolTip 
							+ "\"><label class=\"control-label\" for=\"" + id + "\">" + label + "</label>"
							+ "<div class=\"controls\">"
							+ "<input id=\"" + id + "\" type=\"text\" value=\""+ value + "\">"
							+ "</div>"
							+ "</div></a>";
					}
					else if (type == "select" || type == "toggle") {
						if (type == "toggle") {
							groupID = id;
						}
						form += "<div id=\"" + id + "-cg\" class=\"control-group\">" 
						+ "<a class=\"link\" data-original-title=\"" + toolTip 
						+ "\"><label class=\"control-label\" for=\"" + id + "\">" + label + "</label>"
						+ "<div class=\"controls\">";
						form += "<select id=\"" + id + "\">";
						$(this).find("Options").find("Option").each(function() {
							label = $(this).attr("label");
							value = $(this).text().replace(/\s/g, "");
							form += "<option value=\"" + value + "\">" + label + "</option>";
						});
						form += "</select>"
							 + "</div>"
							 + "</div></a>";

						if (type=="toggle") {
							form += "<div id=\"" + groupID + "-toggle\">";
							$(this).find('Hidable').find('HField').each(function() {
								id = $(this).attr("id");
								var label = $(this).attr("label");
								var type = $(this).attr("type");
								var toolTip = $(this).attr("toolTip");
								var value = $(this).text().replace(/\s/g, "");

								form += "<div id=\"" + id + "-cg\" class=\"control-group\">" 
									+ "<a class=\"link\" data-original-title=\"" + toolTip
									+ "\"><label class=\"control-label\" for=\"" + id + "\">"
									+ label + "</label>"
									+ "<div class=\"controls\">"
									+ "<input id=\"" + id + "\" type=\"text\" value=\""+ value + "\">"
									+ "</div>"
									+ "</div></a>";
							});

							form += "</div> </br>"
								  + "<script>"
								  + "$(\"#" + groupID + "\").change(function() {"
								  + "$('#" + groupID + "-toggle').toggle(this.value == 'True');"
							 	  + "});"
							 	  + "$('#" + groupID + "-toggle').toggle();"
							 	  + "<\/script>";
						}
					}
				});
			});//end xml.find(Group)
			form += "</br><center><div >"
			+ "<button type=\"submit\" class=\"btn btn-success\" "
			+ "onClick=\"validate()\" style=\"margin-right:20px;\">Submit</button>"
			+ "<button class=\"btn btn-danger\" onClick=\"reset()\" >"
			+ "Reset Form</button></div></center>";
			$("#theForum").html(form);
			$(".link").tooltip();


			$('#resolution').change(function () {
				var img = "<a id=\"maplinkR\" href=\"images/Palmyra_40m.jpg\" target=\"_blank\">" +
						  "See a fullscreen map</a><img src=\"images/Palmyra_40m.jpg\"></img>";
						  
				var gmap = "<a id=\"maplinkR\" href=\"gmap.html\" target=\"_blank\">" +
						   "See a fullscreen map</a><iframe id=\"gridR\" src=\"gmap.html\"></iframe>";

				var choice = $("#resolution option:selected").val();
				
				//Show the Hawaii map
				if(choice == "src/himbsyn.bathytopo.1km.v19.grd/himbsyn.bathytopo.1km.v19.grd" ||
				   choice == "src/himbsyn.bathy.v19.grd/himbsyn.bathy.v19.grd") {
					$('#gridLBox').html(gmap);
					$('#gridRBox').html(gmap);
					$('#north').val('23.9999');
					$('#south').val('17.0001');
					$('#east').val('-153.0001');
					$('#west').val('-161.9999');
				} 
				//Show the Palmyra map
				if(choice == "src/palmyra_40m.grd") {
					$('#gridRBox').html(img);
					$('#gridLBox').html(img);
					$('#north').val('6.040205');
					$('#south').val('5.772680');
					$('#east').val('-161.916750');
					$('#west').val('-162.357355');
				} 
			}); //end $(resolution).change

			//Read cookie value if it exists
			var cookieValue = $.cookie("acousticwebapp-data");
			if (cookieValue != "" && !(cookieValue == undefined)) {
				var dic = JSON.parse("{" + cookieValue + "}");
				for(var key in dic) {
					if($("#" + key).length == 0) {
						$("#" + key).val(dic[key]);
					}
				}
			}
			loaded = true;
		}, 'text');
	}

	
	//Validates fields and submits the form
	function validate() {
		var errors = "";
		var res = $("#resolution option:selected").text();
		var cells = 0;
		var dpcR = 0;
		var dpcC = 0;
		var n = 0;
		var s = 0;
		var e = 0;
		var w = 0;
		var noffset = 0;
		var woffset = 0;
		
		if (res == "Hawaiian Isles: 50 meter cells") {
			cells = 50;
		}
		if (res == "Hawaiian Isles: 1 km cells") {
			cells = 1000;
		}
		if (res == "Palmyra Atoll: 40 meter cells") {
			cells = 40;
		}
		//Get user values
		var myn = parseFloat($("#north").val());
		var mys = parseFloat($("#south").val());
		var mye = parseFloat($("#east").val());
		var myw = parseFloat($("#west").val());

		//Data for the 50m dataset
		if(cells == 50){
			//lon delta: 9.0
			//lat delta: 8.0
			//Row_Count: 16001     = 8/16001 = 0.00049996875
			//Col_Count: 18001     = 9/18001 = 0.00049997222
			dpcR = 8/16001.0;
			dpcC = 9/18001.0;

			n = 25;
			s = 17;
			e = -153;
			w = -162;
			noffset = 0;
			woffset = 0;
		}

		//Data for the 1km dataset
		if (cells == 1000){
			//lon delta: 9.0
			//lat delta: 8.0
			//Row_Count: 801 = 8/801 = 0.0099875156
			//Col_Count: 901   9/901 = 0.00998890122
			dpcR = 0.0099;
			dpcC = 0.0099;
			n = 25;
			s = 17;
			e = -153;
			w = -162;
			noffset = 0;
			woffset = 0;
		}
		//Data for the palmyra dataset
		if (cells == 40){
			//lon delta: 0.440605
			//lat delta: 0.267529
		    //Row_Count: 734   0.267529/734 = 0.00036448092
		    //Column_Count: 1217  0.440605/1217 = 0.0003620419
			dpcR = 0.267529/734.0;
			dpcC = 0.440605/1217.0;
			n = 6.040206;
			s = 5.772677;
			e = -161.916751;
			w = -162.357356;
			noffset = 0;
			woffset = 0;
		}
		myn += noffset;
		mys += noffset;
		myw += woffset;
		mye += woffset;

		if(myn > n) {
			errors += "Northern value " + myn + " must be between " + s + " and " + (n - noffset) + ".\n";
		}
		if(mys < s) {
			errors += "Southern value " + mys + " must be between " + s + " and " + (n - noffset) + ".\n";
		}
		if(mye >= e) {
			errors += "Eastern value " + mye + " must be between " + w + " and " + (e - woffset) + ".\n";
		}
		if(myw <= w) {
			errors += "Western value " + myw + " must be between " + w +  " and " + (e - woffset) + ".\n";	
		}
		if(myn<=mys) {
			errors +=  "Northern value (" + myn + ") must be greater than Southern Value (" + mys + ").\n";
		}
		if(mye<=myw) {
			errors +=  "Western value (" + myw +") must be less than Eastern Value (" + mye + ").\n";
		}
		if( errors.length > 0 ){
			alert(errors);
		}
		else {	
			var startX = parseInt((myw-w)/dpcC);
			var XDist = parseInt((mye-myw)/dpcC);
			var startY = parseInt((mys-s)/dpcR);
			var YDist = parseInt((myn-mys)/dpcR);

			//Parse the userSensorList
			var userSensorList = $("#userSensors").val();
			var sensorList = "";
			if (userSensorList != "" && !(typeof userSensorList == "undefined")) {
				//Strip whitespace
				userSensorList = userSensorList.replace(/\s/g, '');
				//Split on commas
				userSensorList = userSensorList.split(","); 
				for (var i=0; i<userSensorList.length/2; i++) {
					var c = parseFloat(userSensorList[2*i]);
					var r = parseFloat(userSensorList[2*i+1]);
					var tc = ((c-myw));
					var tr = ((r-mys));
					c = Math.ceil(parseInt((c-myw)/dpcC));
					r = Math.ceil(parseInt((r-mys)/dpcR));

					sensorList += c + "," + r + ",";
				}
				sensorList = sensorList.substring(0, sensorList.length - 1);
			}
			var dict = "\"startX\":\"" + startX + "\",";
			dict += "\"startY\":\"" + startY + "\",";
			dict += "\"XDist\":\"" + XDist + "\",";
			dict += "\"YDist\":\"" + YDist + "\",";
			dict += "\"inputFile\":\"" + $("#resolution").val() + "\",";
			dict += "\"inputFileType\":\"netcdf\",";
			dict += "\"seriesName\":\"z\",";
			dict += "\"cellSize\":\"" + cells + "\",";
			dict += "\"userSensorList\":\"" + sensorList + "\",";
			submitForm(dict);
		}
	}


	//Submits the form
	function submitForm(dict) {
	    timestamp = new Date().getTime();
		var dic = dict;
		//Gather field values
		$.get("Form.xml", function(data) {
			var xml = $($.parseXML(data));
			xml.find('Group').each(function() {
				//Traverse the xml tree
				//Access field tags
				$(this).find('Fields').find('Field').each(function() {

					var id = $(this).attr("id");
					var type = $(this).attr("type");
					if( type != "toggle") {
						if(type == "select") {
							var value = $("#" + id).val().replace(/\s/g, "");
						}
						else {
							var value = $("#" + id).val().replace(/\s/g, "");
						}
						dic += "\"" + id + "\":\"" + value + "\",";
					}
					else {
						var value = $(this).text().replace(/\s/g, "");
						if(value == 'True') {
							$(this).find('Hidable').find('HField').each(function() {
								id = $(this).attr("id");
								value = $("#" + id).val().replace(/\s/g, "");
								dic += "\"" + id + "\":\"" + value + "\",";
							});
						}
					}
				});
			});
			

			//Add a timestamp
			dic += "\"timestamp\":\"" + timestamp + "\"";
			//write a cookie
			//$.cookie("acousticwebapp-data", dic);
			
			// Actually submit the form
			$.ajax({
				url: '../../query', 
				data: dic,
				success: waitForData,
			});
		}, "text");
	}

	//Waits until the job has been finished by trying to load a <timestamp>.json file 
	function waitForData(data) {
		$('#content').load("progress_bar.html");
		var filename = "../txt/" + timestamp + ".json";
		var exists = UrlExists(filename);
		var waitLoop = setInterval(
			function(){ 
				//Update the progress bar...
				updateProgress();
				exists = UrlExists(filename);
				if (exists) {
						clearInterval(waitLoop);
					  $.ajax({
               dataType: "json",
               url: filename,
               success: function (data) {
                           parseResponse(data);
                         }
             });
				}
			}, 
		 5000);
	}
	
	//Updates the progress bar
	function updateProgress() {
		//Ask the server how far along it is
		var dataString = "\"timestamp\":\"" + timestamp + "\"";
		$.ajax({
               dataType: "json",
               url: "../../status",
               data: dataString,
               success: function (data) {
	               	var value = parseFloat(data) * 100;
	               	var strVal = value + "%";
	               	//document.getElementById('progressBar').style.width = strVal;
	               	$("#progressBar").width(strVal);
               }
             });
	}
	//Checks for the existance of a URL
	function UrlExists(url) {
	    var http = new XMLHttpRequest();
	    http.open('GET', url, false);
	    http.send();
	    return http.status!=404;
	}
	
	//Parses a json file and writes them to the page
	function parseResponse(data) {
		//data = $.parseJSON(data);
		toRet = "<div class=\"result\">";
		//Grab important keys
		params = data["params"];
		sensors = data['sensors'];
		stats = data['stats'];
		filenames = data['filenames'];
		errors = data['errors'];
		err = false;
		
		if(errors!=null) {
			err = true;
			toRet += "<font color=\"red\"><h2>Error!</h2>";
			toRet += "<h3>The program encountered errors and was unable to complete your request.</h3>";
			for(var key in errors) {
				toRet += "<b>Error:</b>" + ": " + errors[parseFloat(key)] + "</br>";
			}
			toRet += "</font>";
			//unset the cookie if an error occured
			$.removeCookie('acousticwebapp-data');
		}
		//Re-Print params
		toRet += "<h3>Parameters:</h3>";
		for(var key in params) {
			toRet += "<b>" + key + "</b>" + ": " + params[key] + "</br>";
			if (key == "sensorList") {
				toRet += "<b>" + key + "</b>" + ": ";
				for(var i=0;i<params.sensorList.length;i++) {
					toRet += "(" + params.sensorList[i].c + "," + params.sensorList[i].r + ") ";
				}
				toRet += "</br>";
			}
		}
		
		if(!err) {
			toRet += "</br><h1>Results:</h1></br><h3>Stats:</h4>";
			for(var key in stats) {
				if(key != "acousticCoverage") {
					toRet +="<b>" + key + "</b>" +  ": " + stats[key] + "</br>";
				}
			}
			
			toRet += "<h3>Graphs:</h4>";
			for(var key in filenames) {
				if(filenames[key].indexOf(".png") != -1) {
					toRet += "<image src=\"../" + filenames[key] + "\"></image>";
				}
				if(filenames[key].indexOf(".zip") != -1) {
					toRet += "</br></br></br><a href=\"../" + filenames[key] + "\">Download a zipped copy of all results</a>";
				}
			}
		}
		toRet += "</br><center><button type=\"submit\" class=\"btn btn-danger\" onClick=\"location.reload()\"> < Back</button></center>";
		toRet += "</div>";
		$('#content').html(toRet);
	}
</script>
