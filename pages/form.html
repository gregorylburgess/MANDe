<div class="row-fluid">
<div class="span4">
	<div id="theForum" class="form-horizontal">
	</div>
</div>
<div class="span8">
<iframe id= "desc" src="parameter_descriptions.html" frameBorder="0">
Your browser doesn't support iframes.
</iframe>
</div>
	<script type="text/javascript">
		var form = "";
		var timestamp = -1;
		$.get("Form.xml", function(data) {
			var xml = $($.parseXML(data));
			xml.find('Group').each(function() {
				//Traverse the xml tree
				var groupID = "";
				var id = $(this).attr("id");
				form += "<h3>" + id + "</h3>";
				if(id == "Bathymetry Variables") {
					form += "<a id=\"maplink\" href=\"gmap.html\" target=\"_blank\">See a fullscreen map</a>";
					form += "<iframe id=\"grid\" src=\"gmap.html\"></iframe>";
				}
				//Access field tags
				$(this).find('Fields').find('Field').each(function() {
					id = $(this).attr("id");
					var label = $(this).attr("label");
					var type = $(this).attr("type");
					var toolTip = $(this).attr("toolTip");
					var value = $(this).text().replace(/\s/g, "");
					
					if (type == 'text') {
						form += "<div id=\"" + id + "-cg\" class=\"control-group\">" 
							+ "<a class=\"link\" data-original-title=\"" + toolTip 
							+ "\"><label class=\"control-label\" for=\"" + id + "\">" + label + "</label>"
							+ "<div class=\"controls\">"
							+ "<input id=\"" + id + "\" type=\"text\" value=\""+ value + "\">"
							+ "</div>"
							+ "</div></a>";
					}
					else if (type == "select" || type == "toggle") {
						if (type == "toggle") {
							groupID = id;
						}
						form += "<div id=\"" + id + "-cg\" class=\"control-group\">" 
						+ "<a class=\"link\" data-original-title=\"" + toolTip 
						+ "\"><label class=\"control-label\" for=\"" + id + "\">" + label + "</label>"
						+ "<div class=\"controls\">";
						form += "<select id=\"" + id + "\">";
						$(this).find("Options").find("Option").each(function() {
							label = $(this).attr("label");
							value = $(this).text().replace(/\s/g, "");
							form += "<option value=\"" + value + "\">" + label + "</option>";
						})
						form += "</select>"
							 + "</div>"
							 + "</div></a>";
	
						if (type=="toggle") {
							form += "<div id=\"" + groupID + "-toggle\">";
							$(this).find('Hidable').find('HField').each(function() {
								id = $(this).attr("id");
								var label = $(this).attr("label");
								var type = $(this).attr("type");
								var toolTip = $(this).attr("toolTip");
								var value = $(this).text().replace(/\s/g, "");
								
								form += "<div id=\"" + id + "-cg\" class=\"control-group\">" 
									+ "<a class=\"link\" data-original-title=\"" + toolTip
									+ "\"><label class=\"control-label\" for=\"" + id + "\">"
									+ label + "</label>"
									+ "<div class=\"controls\">"
									+ "<input id=\"" + id + "\" type=\"text\" value=\""+ value + "\">"
									+ "</div>"
									+ "</div></a>";
							});
							form += "</div> </br>"
								  + "<script>"
								  + "$(\"#" + groupID + "\").change(function() {"
								  + "$('#" + groupID + "-toggle').toggle(this.value == 'True');"
							 	  + "});"
							 	  + "$('#" + groupID + "-toggle').toggle();"
							 	  + "<\/script>";
							 	  
							 	  
						}
					}
					
				});
			});
			form += "</br><center><div >"
			+ "<button type=\"submit\" class=\"btn btn-success\" "
			+ "onClick=\"validate()\" style=\"margin-right:20px;\">Submit</button>"
			+ "<button class=\"btn btn-danger\" onClick=\"reset()\" >"
			+ "Reset Form</button></div></center>";
			$("#theForum").html(form);
			$(".link").tooltip();
			
			//Read cookie value if it exists
			var cookieValue = $.cookie("acousticwebapp-data");
			if (cookieValue != "") {
				var dic = JSON.parse("{"+cookieValue+"}");
				for(var key in dic) {
					$("#" + key).val(dic[key]);
				}
			}
			
		}, 'text');
		

		
		//Validates fields and submits the form
		function validate() {
			var errors = "";
			var res = $("#resolution option:selected").text();
			var cells = 0;
			var dpc = 0;
			var n=0;
			var s=0;
			var e=0;
			var w = 0;
			var noffset=0;
			var woffset=0;
			
			if (res == "50 meter cells") {
				cells = 50;
			}
			if (res == "1 km cells") {
				cells = 1000;
			}
			//Get user values
			var myn = parseFloat($("#north").val());
			var mys = parseFloat($("#south").val());
			var mye = parseFloat($("#east").val());
			var myw = parseFloat($("#west").val());
			
			//Data for the 50m dataset
			if(cells == 50){
				dpc = 0.0005;
				n = 24;
				s = 18;
				e = -154;
				w = -161;
				noffset = 0;
				woffset = 0;
			}
			
			//Data for the 1km dataset
			if (cells == 1000){
				//These are the reported limit values for the himbsyn 1km bathy file
				dpc = 0.01;
				n = 24.5;
				s = 17.5
				e = -154.5;
				w = -161.5;
				//These are the emprical corrections we found
				noffset = .55;
				woffset = .45;
			}
			
			myn += noffset;
			mys += noffset;
			myw += woffset;
			mye += woffset;
			
			if(myn > n) {
				errors += "Northern value " + myn + " must be between " + s + " and " + (n - noffset) + ".\n";
			}
			if(mys < s) {
				errors += "Southern value " + mys + " must be between " + s + " and " + (n - noffset) + ".\n";
			}
			if(mye >= e) {
				errors += "Eastern value " + mye + " must be between " + w + " and " + (e - woffset) + ".\n";
			}
			if(myw <= w) {
				errors += "Western value " + myw + " must be between " + w +  " and " + (e - woffset) + ".\n";	
			}
			if(myn<=mys) {
				errors +=  "Northern value (" + myn + ") must be greater than Southern Value (" + mys+ ").\n";
			}
			if(mye<=myw) {
				errors +=  "Western value (" + myw +") must be less than Eastern Value (" + mye + ").\n";
			}
			if( errors.length > 0 ){
				alert(errors);
			}
			else {
				startX = parseInt((myw-w)/dpc);
				XDist = parseInt((mye-myw)/dpc);
				startY = parseInt((mys-s)/dpc);
				YDist = parseInt((myn-mys)/dpc);
				var dict = "\"startX\":\"" + startX + "\",";
				dict += "\"startY\":\"" + startY + "\",";
				dict += "\"XDist\":\"" + XDist + "\",";
				dict += "\"YDist\":\"" + YDist + "\",";
				dict += "\"inputFile\":\"" + $("#resolution").val() + "\",";
				dict += "\"inputFileType\":\"netcdf\",";
				dict += "\"seriesName\":\"z\",";
				dict += "\"cellSize\":\"" + cells + "\",";
				submitForm(dict);
			}
		}
		
		//Submits the form
		function submitForm(dict) {
		    timestamp = new Date().getTime();
			var dic = dict;
			//Gather field values
			$.get("Form.xml", function(data) {
				var xml = $($.parseXML(data));
				xml.find('Group').each(function() {
					//Traverse the xml tree
					//Access field tags
					$(this).find('Fields').find('Field').each(function() {
	
						var id = $(this).attr("id");
						var type = $(this).attr("type");
						if( type != "toggle") {
							if(type == "select") {
								var value = $("#" + id).val().replace(/\s/g, "");
							}
							else {
								var value = $("#" + id).val().replace(/\s/g, "");
							}
							dic += "\"" + id + "\":\"" + value + "\",";
						}
						else {
							var value = $(this).text().replace(/\s/g, "");
							if(value == 'True') {
								$(this).find('Hidable').find('HField').each(function() {
									id = $(this).attr("id");
									value = $("#" + id).val().replace(/\s/g, "");
									dic += "\"" + id + "\":\"" + value + "\",";
								});
							}
						}
					});
				});
				

				//Add a timestamp
				dic += "\"timestamp\":\"" + timestamp + "\"";
				
				//write a cookie
				$.cookie("acousticwebapp-data", dic);
				// Actually submit the form
				$.ajax({
					url: '../../query', 
					data: dic,
					success: waitForData,
				});
			}, "text");
		}
	
		//Waits until the job has been finished by trying to load a <timestamp>.json file 
		function waitForData(data) {
			var filename = "../txt/" + timestamp + ".json";
			var exists = UrlExists(filename);
			var waitLoop = setInterval(
				function(){ 
					exists = UrlExists(filename);
					if (exists) {
							clearInterval(waitLoop);
						  $.ajax({
                dataType: "json",
                url: filename,
                success: function (data) {
                            parseResponse(data);
                          }
              });
					}
				}, 
			 5000);
		}
		
		//Checks for the existance of a URL
		function UrlExists(url) {
		    var http = new XMLHttpRequest();
		    http.open('GET', url, false);
		    http.send();
		    return http.status!=404;
		}
		
		//Parses a json file and writes them to the page
		function parseResponse(data) {
			//data = $.parseJSON(data);
			toRet = "<div class=\"span1\"></div>";
			toRet += "<div class=\"span10\"><h1>Results:</h1>";
			//Grab important keys
			params = data["params"];
			sensors = data['sensors'];
			stats = data['stats'];
			filenames = data['filenames'];
			
			//Re-Print params
			toRet += "<h3>Parameters:</h4>";
			for(key in params) {
				toRet += "<b>" + key + "</b>" + ": " + params[key] + "</br>";
				if (key == "sensorList") {
					toRet += "<b>" + key + "</b>" + ": ";
					for(var i=0;i<params.sensorList.length;i++) {
						toRet += "(" + params.sensorList[i].c + "," + params.sensorList[i].r + ") ";
						}
				}
			}
			
			toRet += "<h3>Stats:</h4>";
			for(key in stats) {
				if(key != "acousticCoverage") {
					toRet +="<b>" + key + "</b>" +  ": " + stats[key] + "</br>";
				}
			}
			
			toRet += "<h3>Graphs:</h4>";
			for(key in filenames) {
				if(filenames[key].indexOf(".png") != -1) {
					toRet += "<image src=\"../" + filenames[key] + "\"></image>";
				}
				if(filenames[key].indexOf(".zip") != -1) {
					toRet += "</br></br></br><a href=\"../" + filenames[key] + "\">Download a zipped copy of all results</a>";
				}
			}
			
			toRet += "</br><center><button type=\"submit\" class=\"btn btn-danger\" onClick=\"location.reload()\"> < Back</button></center>";
			toRet += "</div><div class=\"span1\"></span>";
			$('#content').html(toRet);
		}

		//Resets the form
		function reset() {
			$.removeCookie('acousticwebapp-data');
			location.reload();
		}
	</script>
</div>
